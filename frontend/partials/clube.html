<script>
  console.log('Script do clube.html a ser DEFINIDO.'); // LOG 1

  // Define a função no escopo global (window)
  window.inicializarClube = function() {
    console.log('Função window.inicializarClube() chamada.'); // LOG 2

    // SELETORES (mantidos)
    const planosContainer = document.querySelector('.clube-planos'); // Seleciona o container dos planos
    const formWrapper = document.getElementById('clube-form-wrapper');
    const formAssinatura = document.getElementById('form-assinatura');
    const planoNomeEl = document.getElementById('plano-selecionado-nome');
    const planoIdInput = document.getElementById('plano-selecionado-id');
    const planoValorInput = document.getElementById('plano-selecionado-valor');
    const statusEl = document.getElementById('clube-status');
    const submitButton = document.getElementById('submit-button');
    const cpfInput = document.getElementById('cliente-cpf');
    const telInput = document.getElementById('cliente-telefone');

    // Verifica elementos essenciais
    if (!planosContainer || !formWrapper || !formAssinatura) {
        console.error('ERRO: Elementos essenciais (planosContainer, formWrapper ou formAssinatura) não encontrados!');
        return;
    }

    // --- ALTERAÇÃO AQUI: USA DELEGAÇÃO DE EVENTOS ---
    // Remove listeners antigos DESTE container para evitar duplicação
    planosContainer.removeEventListener('click', handlePlanoClickDelegado);
    // Adiciona UM listener ao container pai
    planosContainer.addEventListener('click', handlePlanoClickDelegado);
    console.log('Listener de clique DELEGADO adicionado ao .clube-planos'); // LOG 4 ALTERADO

    function handlePlanoClickDelegado(event) {
        // Verifica se o clique foi num botão DENTRO do container
        const botao = event.target.closest('button.btn.btn-primary[data-plano]');

        if (!botao) {
            // Se o clique não foi num botão de plano, ignora
            return;
        }

        console.log('!!! CLIQUE DELEGADO DETETADO !!!', botao); // LOG 5 ALTERADO

        const planoId = botao.dataset.plano;
        const planoValor = botao.dataset.valor;
        const planoNome = botao.closest('.plano-card')?.querySelector('h3')?.textContent || 'Plano Desconhecido';

        console.log('Dados do plano:', { planoId, planoValor, planoNome }); // LOG 6

        // Resto da lógica para mostrar o formulário (inalterada)
        if (planoNomeEl) planoNomeEl.textContent = `Plano ${planoNome}`;
        if (planoIdInput) planoIdInput.value = planoId;
        if (planoValorInput) planoValorInput.value = planoValor;

        if (statusEl) {
            statusEl.textContent = '';
            statusEl.className = '';
        }
        if (submitButton) {
            submitButton.disabled = false;
            submitButton.textContent = 'Prosseguir para Pagamento';
        }

        formWrapper.style.display = 'block';
        console.log('Formulário tornado visível.'); // LOG 7

        if (formWrapper.scrollIntoView) {
            formWrapper.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        const nomeInput = document.getElementById('cliente-nome');
        if (nomeInput) {
             nomeInput.focus();
             console.log('Foco definido no campo Nome.'); // LOG 8
        } else {
            console.warn('Campo Nome (cliente-nome) não encontrado para focar.');
        }
    }
    // --- FIM DA ALTERAÇÃO COM DELEGAÇÃO ---


    // Evento de submit do formulário para enviar ao backend (função handleFormSubmit inalterada)
    formAssinatura.removeEventListener('submit', handleFormSubmit);
    formAssinatura.addEventListener('submit', handleFormSubmit);

    async function handleFormSubmit(event) {
        // ... (código de submit inalterado) ...
         event.preventDefault(); 
       if (statusEl) {
          statusEl.textContent = 'A processar o seu pedido...';
          statusEl.className = 'processing-message'; 
       }
       if (submitButton) {
          submitButton.disabled = true;
          submitButton.textContent = 'Aguarde...';
       }

      const formData = new FormData(formAssinatura);
      const dados = {
        planoId: formData.get('planoId'),
        valor: parseFloat(formData.get('planoValor')), 
        cliente: {
          nome: formData.get('nome'),
          email: formData.get('email'),
          cpf: formData.get('cpf').replace(/\D/g, ''), 
          telefone: formData.get('telefone') ? formData.get('telefone').replace(/\D/g, '') : null 
        }
      };

      try {
        const backendUrl = 'http://localhost:3001/api/criar-assinatura'; 

        const response = await fetch(backendUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(dados),
        });

        const resultado = await response.json();

        if (!response.ok) {
          console.error('Erro recebido do backend:', resultado);
          throw new Error(resultado.message || `Erro ${response.status} do servidor.`);
        }

        if (resultado.paymentLink) {
          if(statusEl) {
             statusEl.textContent = 'Tudo certo! A redirecionar para a página de pagamento...';
             statusEl.className = 'success-message';
          }
          window.location.href = resultado.paymentLink; 
        } else {
           throw new Error('Link de pagamento não recebido do servidor, apesar da resposta OK.');
        }

      } catch (error) {
        console.error('Falha na comunicação com o backend ou erro na resposta:', error);
        if(statusEl) {
            statusEl.textContent = `Erro: ${error.message}`; 
            statusEl.className = 'error-message'; 
        }
        if(submitButton) {
           submitButton.disabled = false; 
           submitButton.textContent = 'Prosseguir para Pagamento';
        }
      }
    } // Fim handleFormSubmit

    // --- Funções de Máscara (inalteradas) ---
    // ... (código das máscaras inalterado) ...
     if (cpfInput) {
        cpfInput.removeEventListener('input', handleCPFMask); // Remove listener antigo
        cpfInput.addEventListener('input', handleCPFMask);
     }
     function handleCPFMask(e) {
         let value = e.target.value.replace(/\D/g, ''); 
         value = value.slice(0, 11); 
         if (value.length > 9) {
             value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{1,2})/, '$1.$2.$3-$4');
         } else if (value.length > 6) {
             value = value.replace(/(\d{3})(\d{3})(\d{1,3})/, '$1.$2.$3');
         } else if (value.length > 3) {
             value = value.replace(/(\d{3})(\d{1,3})/, '$1.$2');
         }
         e.target.value = value;
     }

    if (telInput) {
        telInput.removeEventListener('input', handleTelMask); // Remove listener antigo
        telInput.addEventListener('input', handleTelMask);
    }
    function handleTelMask(e) {
        let value = e.target.value.replace(/\D/g, ''); 
        value = value.slice(0, 11); 
        if (value.length > 10) { 
             value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
        } else if (value.length > 6) { 
             value = value.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
        } else if (value.length > 2) { 
             value = value.replace(/(\d{2})(\d*)/, '($1) $2');
        } else if (value.length > 0) { 
             value = value.replace(/(\d*)/, '($1');
        }
        e.target.value = value;
    }

  } // Fim da função window.inicializarClube

  console.log('Script do clube.html DEFINIDO.'); // LOG FINAL DA DEFINIÇÃO
</script>
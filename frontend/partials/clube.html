<style>
  .clube-planos {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }
  .plano-card {
    border: 1px solid var(--line);
    border-radius: var(--radius);
    padding: 20px;
    text-align: center;
    background-color: #fff;
    box-shadow: var(--shadow);
    display: flex;
    flex-direction: column;
  }
  .plano-card h3 {
    color: var(--brand);
    margin-bottom: 10px;
  }
  .plano-card .preco {
    font-size: 1.8em;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 15px;
  }
   .plano-card .preco small {
    font-size: 0.5em;
    font-weight: 400;
    color: #666; /* Usar uma cor mais suave */
   }
  .plano-card ul {
    list-style: none;
    padding: 0;
    margin-bottom: 20px;
    text-align: left;
    flex-grow: 1; /* Empurra o botão para baixo */
  }
   .plano-card li {
     margin-bottom: 8px;
     text-transform: none; /* Texto normal, não uppercase */
     color: #333; /* Cor do texto dos itens */
     font-size: var(--fz); /* Tamanho de fonte base */
   }
   .plano-card li::before {
      content: '✓';
      color: #28a745; /* Verde sucesso */
      margin-right: 8px;
      font-weight: bold;
   }

  .clube-form {
    max-width: 500px;
    margin: 40px auto 20px auto; /* Aumenta margem superior */
    padding: 25px; /* Mais padding */
    border: 1px solid var(--line);
    border-radius: var(--radius);
    background-color: #fdfdfd; /* Fundo ligeiramente diferente */
    box-shadow: 0 4px 15px rgba(0,0,0,0.05); /* Sombra suave */
  }
   .clube-form h2 {
     text-align: center;
     margin-bottom: 25px; /* Mais espaço abaixo do título */
     font-size: 1.3em;
   }
   /* Estilos dos campos adaptados de eventos.css */
   .field {
        display: block;
        margin-bottom: 15px; /* Aumenta espaço entre campos */
    }
    .field label { /* Adaptado de .field > span em eventos.css */
        display: block;
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        margin-bottom: 6px;
        color: var(--brand);
    }
    .field input { /* Adaptado de .field input em eventos.css */
        width: 100%;
        padding: 12px;
        border-radius: 12px;
        border: 2px solid transparent;
        background-color: #eef5fa;
        outline: none;
        transition: border-color .2s, box-shadow .2s, background-color .2s;
        font-family: "Poppins", sans-serif;
        font-size: var(--fz-lg); /* Tamanho de fonte maior para inputs */
    }
    .field input:focus-visible { /* Adaptado de eventos.css */
        border-color: var(--brand);
        box-shadow: 0 0 0 3px color-mix(in srgb, var(--brand), transparent 75%);
        background-color: #fff;
    }
    /* Estilo para o botão dentro do formulário */
    .clube-form .btn {
        width: 100%;
        padding: 12px 14px; /* Botão ligeiramente maior */
        font-size: var(--fz-lg);
    }

   #clube-status {
     margin-top: 20px; /* Mais espaço acima da mensagem de status */
     text-align: center;
     font-weight: bold;
     min-height: 1.5em; /* Garante espaço mesmo sem texto */
   }
   /* Classe para feedback de erro */
    .error-message {
        color: #c0392b; /* Vermelho erro */
        background-color: #fdd; /* Fundo rosa claro */
        border: 1px solid #c0392b;
        padding: 10px;
        border-radius: 8px;
        margin-top: 15px;
    }
    /* Classe para feedback de sucesso */
    .success-message {
        color: #28a745; /* Verde sucesso */
        /* Estilos similares ao erro se desejar */
    }
    /* Classe para feedback de processamento */
    .processing-message {
        color: #fd7e14; /* Laranja */
    }
</style>

<section class="section">
  <h1>CLUBE CÓDIGO</h1>
  <p style="text-align: center; max-width: 600px; margin: 0 auto 30px auto; text-transform: none; font-size: var(--fz-lg);">
    Escolha o plano ideal para si, receba mensalmente uma seleção exclusiva dos melhores cortes e desfrute de benefícios únicos.
  </p>
</section>

<section class="section">
  <div class="clube-planos">
    <div class="plano-card">
      <h3>BRONZE</h3>
      <div class="preco">R$ 199<small>,90/mês</small></div>
      <ul>
        <li>Seleção especial de carnes do dia a dia</li>
        <li>Ideal para refeições práticas e saborosas</li>
        <li>Aproximadamente 2kg de carne por mês</li>
        <li>Entrega mensal programada</li>
      </ul>
      <button class="btn btn-primary" data-plano="bronze" data-valor="199.90">Selecionar Bronze</button>
    </div>
    <div class="plano-card">
      <h3>PRATA</h3>
      <div class="preco">R$ 299<small>,90/mês</small></div>
      <ul>
        <li>Mix de cortes nobres e do dia a dia</li>
        <li>Perfeito para o churrasco do fim de semana</li>
        <li>Aproximadamente 2.5kg de carne por mês</li>
        <li>Brinde surpresa ocasional (tempero, acessório)</li>
      </ul>
      <button class="btn btn-primary" data-plano="prata" data-valor="299.90">Selecionar Prata</button>
    </div>
    <div class="plano-card">
      <h3>OURO</h3>
      <div class="preco">R$ 399<small>,90/mês</small></div>
      <ul>
        <li>Seleção premium com cortes exclusivos</li>
        <li>Inclui cortes especiais (ex: Wagyu, Cordeiro)</li>
        <li>Aproximadamente 3kg de carne por mês</li>
        <li>Acesso prioritário a novidades e eventos</li>
      </ul>
      <button class="btn btn-primary" data-plano="ouro" data-valor="399.90">Selecionar Ouro</button>
    </div>
  </div>

  <div id="clube-form-wrapper" class="clube-form" style="display: none;">
    <h2>Complete os seus dados para assinar o <span id="plano-selecionado-nome" style="color: var(--brand);"></span></h2>
    <form id="form-assinatura">
      <input type="hidden" id="plano-selecionado-id" name="planoId">
      <input type="hidden" id="plano-selecionado-valor" name="planoValor">

      <div class="field">
        <label for="cliente-nome">Nome Completo:</label>
        <input type="text" id="cliente-nome" name="nome" required autocomplete="name">
      </div>
      <div class="field">
        <label for="cliente-email">E-mail:</label>
        <input type="email" id="cliente-email" name="email" required autocomplete="email">
      </div>
      <div class="field">
        <label for="cliente-cpf">CPF:</label>
        <input type="text" id="cliente-cpf" name="cpf" placeholder="000.000.000-00" required inputmode="numeric">
      </div>
       <div class="field">
        <label for="cliente-telefone">Telefone (com DDD):</label>
        <input type="tel" id="cliente-telefone" name="telefone" placeholder="(XX) XXXXX-XXXX" autocomplete="tel">
      </div>

      <button type="submit" id="submit-button" class="btn btn-primary">Prosseguir para Pagamento</button>

      <div id="clube-status"></div>
    </form>
  </div>
</section>

<script>
  // Garante que o código só corre depois do HTML estar pronto
  document.addEventListener('DOMContentLoaded', () => {

    const botoesPlano = document.querySelectorAll('.clube-planos button');
    const formWrapper = document.getElementById('clube-form-wrapper');
    const formAssinatura = document.getElementById('form-assinatura');
    const planoNomeEl = document.getElementById('plano-selecionado-nome');
    const planoIdInput = document.getElementById('plano-selecionado-id');
    const planoValorInput = document.getElementById('plano-selecionado-valor');
    const statusEl = document.getElementById('clube-status');
    const submitButton = document.getElementById('submit-button');
    const cpfInput = document.getElementById('cliente-cpf');
    const telInput = document.getElementById('cliente-telefone');

    // Função para mostrar o formulário ao selecionar plano
    botoesPlano.forEach(botao => {
      botao.addEventListener('click', () => {
        const planoId = botao.dataset.plano;
        const planoValor = botao.dataset.valor;
        // Pega o nome do H3 que está dois níveis acima do botão
        const planoNome = botao.closest('.plano-card').querySelector('h3').textContent; 

        planoNomeEl.textContent = `Plano ${planoNome}`;
        planoIdInput.value = planoId;
        planoValorInput.value = planoValor;
        
        // Limpa status/erros anteriores e reativa o botão
        statusEl.textContent = '';
        statusEl.className = ''; // Remove classes de erro/sucesso
        submitButton.disabled = false;
        submitButton.textContent = 'Prosseguir para Pagamento';

        formWrapper.style.display = 'block';
        
        // Rola a página suavemente até ao formulário
        formWrapper.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        document.getElementById('cliente-nome').focus(); // Foca no primeiro campo
      });
    });

    // Evento de submit do formulário para enviar ao backend
    formAssinatura.addEventListener('submit', async (event) => {
      event.preventDefault(); // Impede o envio padrão do HTML
      
      // Feedback visual e desativa botão para evitar cliques múltiplos
      statusEl.textContent = 'A processar o seu pedido...';
      statusEl.className = 'processing-message'; // Adiciona classe para estilo
      submitButton.disabled = true;
      submitButton.textContent = 'Aguarde...';

      const formData = new FormData(formAssinatura);
      const dados = {
        planoId: formData.get('planoId'),
        // Garante que o valor é enviado como número
        valor: parseFloat(formData.get('planoValor')), 
        cliente: {
          nome: formData.get('nome'),
          email: formData.get('email'),
          cpf: formData.get('cpf').replace(/\D/g, ''), // Envia só números
          // Envia telefone apenas se preenchido
          telefone: formData.get('telefone') ? formData.get('telefone').replace(/\D/g, '') : null 
        }
      };

      try {
        // !!! IMPORTANTE: Ajuste este URL para o endereço real do seu backend !!!
        // Ex: 'https://seu-dominio.com/api/criar-assinatura' em produção
        // Ex: 'http://localhost:3001/api/criar-assinatura' se o backend rodar localmente na porta 3001
        const backendUrl = 'http://localhost:3001/api/criar-assinatura'; 

        const response = await fetch(backendUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(dados),
        });

        // Tenta ler a resposta JSON independentemente do status
        const resultado = await response.json();

        if (!response.ok) {
           // Se a resposta não foi OK (ex: 400, 500), lança um erro com a mensagem do backend
          console.error('Erro recebido do backend:', resultado);
          throw new Error(resultado.message || `Erro ${response.status} do servidor.`);
        }

        // Se chegou aqui, a resposta foi OK (ex: 200)
        if (resultado.paymentLink) {
          statusEl.textContent = 'Tudo certo! A redirecionar para a página de pagamento...';
          statusEl.className = 'success-message';
          // Redireciona o utilizador para a página de pagamento segura do Asaas
          window.location.href = resultado.paymentLink; 
        } else {
           // Se a resposta foi OK mas não veio o link (pouco provável com UNDEFINED billingType)
           throw new Error('Link de pagamento não recebido do servidor, apesar da resposta OK.');
        }

      } catch (error) {
        console.error('Falha na comunicação com o backend ou erro na resposta:', error);
        // Mostra o erro específico no ecrã
        statusEl.textContent = `Erro: ${error.message}`; 
        statusEl.className = 'error-message'; // Adiciona classe para estilo de erro
        // Reativa o botão para o utilizador tentar novamente
        submitButton.disabled = false; 
        submitButton.textContent = 'Prosseguir para Pagamento';
      }
    });

    // --- Funções de Máscara (Melhoria de UX) ---
    if (cpfInput) {
       cpfInput.addEventListener('input', (e) => {
           let value = e.target.value.replace(/\D/g, ''); // Remove tudo que não for dígito
           value = value.slice(0, 11); // Limita a 11 dígitos

           if (value.length > 9) {
               value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{1,2})/, '$1.$2.$3-$4');
           } else if (value.length > 6) {
               value = value.replace(/(\d{3})(\d{3})(\d{1,3})/, '$1.$2.$3');
           } else if (value.length > 3) {
               value = value.replace(/(\d{3})(\d{1,3})/, '$1.$2');
           }
           e.target.value = value;
       });
    }

    if (telInput) {
        telInput.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, ''); // Remove tudo que não for dígito
            value = value.slice(0, 11); // Limita a (DD) + 9 dígitos

            if (value.length > 10) { // Celular (DD) NNNNN-NNNN
                 value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            } else if (value.length > 6) { // Fixo (DD) NNNN-NNNN ou Celular antigo
                 value = value.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
            } else if (value.length > 2) { // (DD) NNNN
                 value = value.replace(/(\d{2})(\d*)/, '($1) $2');
            } else if (value.length > 0) { // (DD
                 value = value.replace(/(\d*)/, '($1');
            }
            e.target.value = value;
        });
    }

  }); // Fim do DOMContentLoaded
</script>